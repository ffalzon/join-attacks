\section{Matachable Record Recovery with $\calF_{\MKPM}$}\label{sec:PSUCA_to_matching}

In this section, we show how the $\PSUCAattack{}$ attack can be applied to the $\calF_{\MKPM}$ functionality with some additional assumptions to achieve \emph{matchable record recovery} (Definition~\ref{def:matchable_records_recovery}).
In Appendix~\ref{sec:psuca-privateID-attack} we further explain how the attack can be applied to the single key private matching functionality $\calF_{\SKPM}$ realized by PrivateID~\cite{PMC}.

The adversary is given a target set of records $T \subseteq \Ispace{}^n$, and can evaluate $\calF_{\MKPM}(X, Y)$ for arbitrarily many inputs $X$. Its goal is to determine the set of matchable records, $T \sqcap Y$.
The functionality $\mathcal F_{\MKPM}$ outputs the set universal identifiers, $\UID$, to both parties. Rather than assigning a common UID to two identical records, it applies a matching logic (see Figure~\ref{fig:match_logic}) which assigns a common UID to each pair of matched records, and a distinct UID to every unmatched record in $T$ and $Y$. Thus, using $|\UID|$ as the cardinality for carrying out the $\PSUCAattack{}$ appears to be a natural approach for identifying matching records in $T$.

Recall that the $\PSUCAattack{}$ attack (Section~\ref{sec:psu-psuca}) relies on the fact that $|X \cup Y| = |X_1 \cup Y| + |X_2 \cup Y| - |Y|$ (Eq.~\ref{eqn:union_intersect_cardinalities}), where $X$ and $Y$ are arbitrary sets and $X_1\cup X_2$ form a partition of $X$.

We now translate this to the multi-key setting. Let $X, Y$ be sets of records, and let $X_1\cup X_2$ be a partition of $X$. Moreover, let $\UID$, $\UID_1$, and $\UID_2$ be the UIDs output when evaluating $\calF_{\MKPM}(X, Y)$ and $\calF_{\MKPM}(X_i, Y)$ for $i \in \{1, 2\}$ respectively. Then we require the following relation to hold:
\begin{equation}
    \label{eqn:MKPM_PSUCA_condition}
    |\UID| = |\UID_1| + |\UID_2| - |Y|.
\end{equation}

Unfortunately, this condition does not hold for general inputs. The reason is that the MKPM functionality shuffles the inputs before applying the matching logic. Consequently, the matching procedure introduces randomness, leading to inconsistent record matches across different protocol runs, even with the same input sets. Thus, different evaluations of $\calF_\MKPM$ on identical inputs can yield $\UID$ sets with varying cardinalities.

We give an example of such a matching in Figure~\ref{fig:MPMK_PSUCA_counterexample}. 

To avoid such cases, we define a restriction on the input sets that, if satisfied, ensures that Eq.~\ref{eqn:MKPM_PSUCA_condition} holds, thus allowing us to carry out the attack. Luckily, one-to-many relations do not violate Eq.~\ref{eqn:MKPM_PSUCA_condition}.
It therefore suffices to exclude many-to-one relations.

\begin{definition}\label{def:isolated_set}
	Let $X, Y$ be sets of records.
	We say $X$ is \textbf{$Y$-isolated}, 
	if for all $\by\in Y$ we have 
	$$|\{\bx \in X \setdsc \exists i, j \text{ s.t. } \bx[i] = \by[j]\}| \leq 1.$$
\end{definition}

This constraint may exclude certain scenarios. For example, if the sets contain IP addresses, many-to-one relationships are likely to occur since multiple users in the same local network share an IP address. However, the adversary's input may be $Y$-isolated in scenarios where the adversary targets a specific range of identifiers, such as all phone numbers with a specific area code or all email addresses from a particular domain. \ff{maybe make reference to experiments here?}


\begin{theorem}\label{thm:psu-mkpm:correctness}
	Let $T,V\subseteq \Ispace{}^n$ are sets of records.
	If $T$ is $Y$-isolated, then 
	$\PSUCAattack^{\calF_{\MKPM}(\cdot, Y)}(T)$ recovers $T \sqcap Y$.
\end{theorem}

The proof can be find in Appendix~\ref{sec:psu-mkpm:correctness}.

\heading{Time and query complexity.}
The $\PSUCAattack{}$ can be applied directly to the output of $\calF_{\MKPM}$, as long as the adversary's input sets satisfy Definition~\ref{def:isolated_set}. Thus, the attack has the same worst-case time complexity and maximum number of protocol invocations as when applied to $\calF_{\PSUCA}$. Specifically, it requires $\bigO{n\log n}$ time and at most $n + 1$ protocol invocations (although typically fewer queries are needed due to the probability of early termination).

\begin{figure}
	\centering
	\input{figures/example-psu-mkpm-attack.tex}
	\caption{Example of a target set $T$ and a recovery set $Y$, such that $\PSUCAattack{}$ cannot be applied to the output of $\calF_{\MKPM}(T;Y)$.
	Lines between records indicate potential matches based on matching identifiers. 
	Solid lines denote the matched records chosen by the matching logic.
	We see that $|\UID| \neq |\UID_1| + |\UID_2| - |Y|$ and, as such, $T$ is not $Y$-isolated.}
	\label{fig:MPMK_PSUCA_counterexample}
\end{figure}